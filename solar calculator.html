<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar System Sizing Calculator - WM Project</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Top */
            left: 50%; /* Center horizontally */
            margin-left: -100px; /* Adjust for width */
            opacity: 0;
            transition: opacity 0.3s;
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%; /* At the bottom of the tooltip */
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        /* Style for formulas in PDF */
        .pdf-formula {
            font-size: 0.7em; /* Smaller font */
            color: #555; /* Slightly lighter color */
            margin-left: 8px; /* Space after the value */
        }

        /* New styles for PDF output */
        .pdf-heading-main {
            text-transform: uppercase;
            text-decoration: none;
            font-family: 'Times New Roman', serif; /* Fallback to generic serif */
            text-align: center; /* Center the main heading */
            font-size: 14pt; /* Main heading font size */
            width: 100%; /* Ensure it takes full width for centering */
            display: block; /* Ensure it's a block element for text-align to work */
        }
        .pdf-heading-sub {
            text-transform: uppercase;
            font-family: 'Times New Roman', serif; /* Fallback to generic serif */
            font-size: 11pt; /* Subheading font size */
        }
        .pdf-body-font {
            font-family: 'Times New Roman', serif; /* Fallback to generic serif */
            font-size: 10pt; /* Body text font size */
        }
        #loadingMessage {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            z-index: 1000;
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-6 text-blue-700">Solar System Sizing Calculator</h1>
        <p class="text-center text-gray-600 mb-8">Easily calculate the solar system size for your home or institution</p>

        <div id="loadEntryPanel" class="space-y-6">
            <h2 class="text-2xl font-semibold mb-4 text-left text-gray-800">Enter Load Details</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                <div>
                    <label for="selectedVoltage" class="block text-gray-700 text-sm font-bold mb-2">Selected Voltages:</label>
                    <select id="selectedVoltage" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="">Select</option>
                        <option value="220">220V</option>
                        <option value="400">400V</option>
                    </select>
                </div>
                <div>
                    <label for="selectedPhase" class="block text-gray-700 text-sm font-bold mb-2">Selected Phase:</label>
                    <select id="selectedPhase" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="">Select</option>
                        <option value="single">Single Phase</option>
                        <option value="three">Three Phase</option>
                    </select>
                </div>
                <div>
                    <label for="selectedPowerFactor" class="block text-gray-700 text-sm font-bold mb-2">Selected Power Factor:</label>
                    <select id="selectedPowerFactor" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="">Select</option>
                        <option value="0.8">0.8</option>
                        <option value="0.5">0.5</option>
                    </select>
                </div>
                <div>
                    <label for="systemType" class="block text-gray-700 text-sm font-bold mb-2">System Type:</label>
                    <select id="systemType" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="">Select</option>
                        <option value="on-grid">On Grid</option>
                        <option value="hybrid">Hybrid</option>
                    </select>
                </div>
                 <div>
                    <label for="selectedBatteryCapacity" class="block text-gray-700 text-sm font-bold mb-2">Selected Battery Capacity (Ah):</label>
                    <select id="selectedBatteryCapacity" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="">Select</option>
                        <option value="100">100Ah</option>
                        <option value="120">120Ah</option>
                        <option value="150">150Ah</option>
                        <option value="185">185Ah</option>
                        <option value="200">200Ah</option>
                    </select>
                </div>
                <div>
                    <label for="selectedPanelWattage" class="block text-gray-700 text-sm font-bold mb-2">Selected Solar Panel Capacity (W):</label>
                    <select id="selectedPanelWattage" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="">Select</option>
                        <option value="185">185W</option>
                        <option value="250">250W</option>
                        <option value="300">300W</option>
                        <option value="350">350W</option>
                        <option value="580">580W</option>
                        <option value="585">585W</option>
                        <option value="605">605W</option>
                        <option value="700">700W</option>
                    </select>
                </div>
                <div>
                    <label for="backupHours" class="block text-gray-700 text-sm font-bold mb-2">Backup Hours:</label>
                    <input type="number" id="backupHours" value="" min="1" class="w-full p-2 border rounded-md text-right focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <div>
                    <label for="dailyUsageHours" class="block text-gray-700 text-sm font-bold mb-2">Daily Usage Hours:</label>
                    <input type="number" id="dailyUsageHours" value="" min="1" class="w-full p-2 border rounded-md text-right focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
            </div>

            <div class="flex justify-end mb-4">
                <button onclick="addRow()" class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 transition duration-200 shadow-md">Add New Row</button>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                    <thead>
                        <tr class="bg-blue-100 text-blue-800 text-center">
                            <th class="py-3 px-4 border-b">Appliances Name</th>
                            <th class="py-3 px-4 border-b">Quantity</th>
                            <th class="py-3 px-4 border-b">Wattage (Watts)</th>
                            <th class="py-3 px-4 border-b">Demand Factor (%)</th>
                            <th class="py-3 px-4 border-b">Battery Backup?</th>
                            <th class="py-3 px-4 border-b">Action</th>
                        </tr>
                    </thead>
                    <tbody id="loadTableBody">
                        </tbody>
                </table>
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="calculateSolarSystem()" class="w-full md:w-auto bg-blue-600 text-white py-3 px-8 rounded-md hover:bg-blue-700 transition duration-200 shadow-lg">Calculate</button>
            </div>
        </div>

        <div id="resultPanel" class="hidden space-y-6 mt-8">
            <h2 class="text-2xl font-semibold mb-4 text-left text-gray-800" id="mainResultHeading">Solar System Details</h2>

            <div class="bg-gray-50 p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-medium mb-4 text-gray-700 text-left result-subheading">System Configuration</h3>
                <p class="text-left text-gray-700 mb-2 result-text">
                    <span class="font-semibold">Selected Voltage:</span> <span id="outputVoltage"></span>
                </p>
                <p class="text-left text-gray-700 mb-2 result-text">
                    <span class="font-semibold">Selected Phase:</span> <span id="outputPhase"></span>
                </p>
                <p class="text-left text-gray-700 mb-2 result-text">
                    <span class="font-semibold">Selected Power Factor:</span> <span id="outputPowerFactor"></span>
                </p>
                <p class="text-left text-gray-700 mb-2 result-text">
                    <span class="font-semibold">System Type:</span> <span id="outputSystemType"></span>
                </p>
                <p class="text-left text-gray-700 mb-2 result-text">
                    <span class="font-semibold">Selected Battery Capacity:</span> <span id="outputBatteryCapacity"></span>
                </p>
                <p class="text-left text-gray-700 result-text">
                    <span class="font-semibold">Selected Solar Panel Capacity:</span> <span id="outputPanelWattage"></span>
                </p>
            </div>

            <div class="bg-blue-50 p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-medium mb-4 text-blue-700 text-left result-subheading">Load Information</h3>
                <p class="text-left text-gray-700 mb-2 result-text">
                    <span class="font-semibold">Total Connected Load:</span> <span id="connectedLoadOutput">0</span> kW
                    <span class="tooltip float-right">
                        <span class="text-blue-500">&#9432;</span>
                        <span class="tooltiptext" data-formula="Connected Load = SUM(Quantity × Wattage)">Connected Load = SUM(Quantity × Wattage)</span>
                    </span>
                </p>
                <p class="text-left text-gray-700 mb-2 result-text">
                    <span class="font-semibold">Demand Load (after Demand Factor & 10% Margin):</span> <span id="demandLoadOutput">0</span> kW
                    <span class="tooltip float-right">
                        <span class="text-blue-500">&#9432;</span>
                        <span class="tooltiptext" data-formula="Demand Load = Connected Load × Avg. Demand Factor (%) × 1.10 (10% Margin)">Demand Load = Connected Load × Avg. Demand Factor (%) × 1.10 (10% Margin)</span>
                    </span>
                </p>
                <p class="text-left text-gray-700 result-text">
                    <span class="font-semibold">Daily Electricity Usage:</span> <span id="dailyUsageOutput">0</span> kWh
                    <span class="tooltip float-right">
                        <span class="text-blue-500">&#9432;</span>
                        <span class="tooltiptext" data-formula="Daily kWh Usage = Adjusted Demand Load (KW) × Daily Usage Hours">Daily kWh Usage = Adjusted Demand Load (KW) × Daily Usage Hours</span>
                    </span>
                </p>
            </div>

            <div class="bg-green-50 p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-medium mb-4 text-green-700 text-left result-subheading">Battery Sizing</h3>
                <p class="text-left text-gray-700 mb-2 result-text">
                    <span class="font-semibold">Required Battery Storage:</span> <span id="batteryStorageOutput">0</span> kWh
                    <span class="tooltip float-right">
                        <span class="text-blue-500">&#9432;</span>
                        <span class="tooltiptext" data-formula="Battery Size Needed (kWh) = Adjusted Load (KW) × Backup Time (hr) ÷ DoD × Inverter Efficiency">Battery Size Needed (kWh) = Adjusted Load (KW) × Backup Time (hr) ÷ DoD × Inverter Efficiency<br>(Assumed DoD = 80%, Inverter Efficiency = 90%)</span>
                    </span>
                </p>
                <p class="text-left text-gray-700 result-text">
                    <span class="font-semibold">Number of Batteries (based on selected capacity):</span> <span id="numBatteriesOutput">0</span> Batteries
                    <span class="tooltip float-right">
                        <span class="text-blue-500">&#9432;</span>
                        <span class="tooltiptext" data-formula="Number of Batteries = Battery Bank (kWh) / Single Battery kWh">Number of Batteries = Battery Bank (kWh) / Single Battery kWh<br>(Calculated based on 12V and selected Ah capacity)</span>
                    </span>
                </p>
            </div>

            <div class="bg-yellow-50 p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-medium mb-4 text-yellow-700 text-left result-subheading">Solar Panel Details</h3>
                <p class="text-left text-gray-700 mb-2 result-text">
                    <span class="font-semibold">Total Required Solar Panel Capacity:</span> <span id="totalPanelKWOutput">0</span> kW
                    <span class="tooltip float-right">
                        <span class="text-blue-500">&#9432;</span>
                        <span class="tooltiptext" data-formula="Total Solar Panel Capacity (kW) = Daily kWh Usage ÷ Avg. Sunlight (e.g., 5 hrs)">Total Solar Panel Capacity (kW) = Daily kWh Usage ÷ Avg. Sunlight (e.g., 5 hrs)</span>
                    </span>
                </p>
                <p class="text-left text-gray-700 result-text">
                    <span class="font-semibold">Number of Solar Panels (based on selected capacity):</span> <span id="numPanelsOutput">0</span> Panels
                    <span class="tooltip float-right">
                        <span class="text-blue-500">&#9432;</span>
                        <span class="tooltiptext" data-formula="Panels Needed = Total Panel Capacity (kW) ÷ (Selected Panel Wattage / 1000)">Panels Needed = Total Panel Capacity (kW) ÷ (Selected Panel Wattage / 1000)<br>(Calculated based on selected panel wattage)</span>
                    </span>
                </p>
            </div>

            <div class="bg-purple-50 p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-medium mb-4 text-purple-700 text-left result-subheading">Inverter Suggestion</h3>
                <p class="text-left text-gray-700 result-text">
                    <span class="font-semibold">Suggested Inverter Size:</span> <span id="inverterSuggestionOutput">0</span> kW Hybrid
                    <span class="tooltip float-right">
                        <span class="text-blue-500">&#9432;</span>
                        <span class="tooltiptext">Suggested Inverter Size = Adjusted Demand Load (KW) (Rounded Up)</span>
                    </span>
                </p>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mt-6" id="pdfButtonsContainer">
                <button onclick="resetCalculator()" class="w-full md:w-auto bg-gray-600 text-white py-3 px-8 rounded-md hover:bg-gray-700 transition duration-200 shadow-md">Recalculate</button>
                <button onclick="downloadPdf()" class="w-full md:w-auto bg-red-600 text-white py-3 px-8 rounded-md hover:bg-red-700 transition duration-200 shadow-md">Download as PDF</button>
            </div>
        </div>
    </div>

    <div id="loadingMessage">Generating PDF...</div>

    <script>
        // Global variable to store appliance data for PDF
        let appliancesDataForPdf = [];

        // List of common appliances for the dropdown
        const commonAppliances = [
            "Select Appliance",
            "Wall Lights", "Street Lights", "Fans", "AC", "Refrigerator",
            "Washing Machine", "Water Pump", "TV", "Computer", "Microwave",
            "Electric Iron", "Water Heater",
            "Oven", "Dishwasher", "Security System",
            "CCTV Camera", "Router", "Chargers", "Other"
        ];

        // Function to add a new row to the load table
        function addRow(applianceName = "Select Appliance", qty = "", wattage = "", demandFactor = "", isBatteryBackup = false) {
            const tableBody = document.getElementById('loadTableBody');
            const newRow = document.createElement('tr');
            newRow.className = 'border-b last:border-b-0 text-left';

            // Create the select element for appliances
            const applianceSelect = document.createElement('select');
            applianceSelect.className = 'w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 appliance-select';
            applianceSelect.onchange = function() {
                // Update the hidden input's value with the selected option's text
                this.closest('td').querySelector('.appliance-name-input').value = this.value;
            };

            // Populate the select with common appliances
            commonAppliances.forEach(appliance => {
                const option = document.createElement('option');
                option.value = appliance;
                option.textContent = appliance;
                applianceSelect.appendChild(option);
            });

            // Set the selected value if an applianceName is provided
            applianceSelect.value = applianceName;

            // Create a hidden input to store the actual appliance name for calculation
            const hiddenApplianceInput = document.createElement('input');
            hiddenApplianceInput.type = 'hidden';
            hiddenApplianceInput.className = 'appliance-name-input';
            hiddenApplianceInput.value = applianceName; // Initialize with provided name

            newRow.innerHTML = `
                <td class="py-3 px-4">
                    <div class="appliance-select-container"></div>
                    <input type="hidden" class="appliance-name-input" value="${applianceName}">
                </td>
                <td class="py-3 px-4"><input type="number" value="${qty}" min="0" class="w-full p-2 border rounded-md text-right focus:outline-none focus:ring-2 focus:ring-blue-400 qty"></td>
                <td class="py-3 px-4"><input type="number" value="${wattage}" min="0" class="w-full p-2 border rounded-md text-right focus:outline-none focus:ring-2 focus:ring-blue-400 wattage"></td>
                <td class="py-3 px-4"><input type="number" value="${demandFactor}" min="0" max="100" class="w-full p-2 border rounded-md text-right focus:outline-none focus:ring-2 focus:ring-400 demand-factor"></td>
                <td class="py-3 px-4 text-center"><input type="checkbox" class="battery-backup-checkbox" ${isBatteryBackup ? 'checked' : ''}></td>
                <td class="py-3 px-4 text-center"><button onclick="removeRow(this)" class="bg-red-500 text-white p-2 rounded-md hover:bg-red-600 transition duration-200">Remove</button></td>
            `;

            // Use prepend to add the new row at the top of the tbody
            tableBody.prepend(newRow);

            // Append the dynamically created select element to its container
            newRow.querySelector('.appliance-select-container').appendChild(applianceSelect);
        }

        // Function to remove a row from the load table
        function removeRow(button) {
            const row = button.closest('tr');
            row.remove();
        }

        // Function to calculate the solar system sizing
        function calculateSolarSystem() {
            let totalConnectedLoadWatts = 0;
            let totalDemandLoadWatts = 0;
            let totalBatteryBackupLoadWatts = 0; // New variable for battery backup specific load

            appliancesDataForPdf = []; // Clear previous data

            const rows = document.querySelectorAll('#loadTableBody tr');
            rows.forEach(row => {
                const applianceName = row.querySelector('.appliance-name-input').value;
                const qty = parseFloat(row.querySelector('.qty').value) || 0;
                const wattage = parseFloat(row.querySelector('.wattage').value) || 0;
                const demandFactor = parseFloat(row.querySelector('.demand-factor').value) || 0;
                const isBatteryBackup = row.querySelector('.battery-backup-checkbox').checked;

                const connectedLoad = qty * wattage;
                const demandLoad = connectedLoad * (demandFactor / 100);

                totalConnectedLoadWatts += connectedLoad;
                totalDemandLoadWatts += demandLoad;

                if (isBatteryBackup) {
                    totalBatteryBackupLoadWatts += demandLoad;
                }

                // Store relevant data for PDF
                appliancesDataForPdf.push({
                    appliance: applianceName,
                    quantity: qty,
                    wattage: wattage,
                    demandFactor: demandFactor,
                    isBatteryBackup: isBatteryBackup ? 'yes' : 'no' // Convert boolean to string for display
                });
            });

            const connectedLoadKW = totalConnectedLoadWatts / 1000;
            const demandLoadKW = totalDemandLoadWatts / 1000;
            const batteryBackupLoadKW = totalBatteryBackupLoadWatts / 1000; // Convert to KW

            // Apply 10% margin to demand and battery backup loads
            const adjustedDemandLoadKW = demandLoadKW * 1.10;
            const adjustedBatteryBackupLoadKW = batteryBackupLoadKW * 1.10;


            // Get selected battery capacity, solar panel wattage, backup hours and daily usage hours from input
            const selectedBatteryCapacityAh = parseFloat(document.getElementById('selectedBatteryCapacity').value);
            if (isNaN(selectedBatteryCapacityAh) || selectedBatteryCapacityAh <= 0) {
                alert("Please select a valid Battery Capacity.");
                return;
            }
            const selectedPanelWattage = parseFloat(document.getElementById('selectedPanelWattage').value);
            if (isNaN(selectedPanelWattage) || selectedPanelWattage <= 0) {
                alert("Please select a valid Solar Panel Capacity.");
                return;
            }

            const backupHours = parseFloat(document.getElementById('backupHours').value) || 1;
            const dailyUsageHours = parseFloat(document.getElementById('dailyUsageHours').value) || 8;


            // Constants for calculations
            const DoD = 0.8; // Depth of Discharge (80%)
            const inverterEfficiency = 0.9; // Inverter Efficiency (90%)
            const singleBatteryVoltage = 12; // Assuming 12V per battery
            const singleBatteryKWh = (singleBatteryVoltage * selectedBatteryCapacityAh) / 1000; // Calculate based on selected Ah
            const avgSunlightHours = 5; // Average daily sunlight hours

            // 1. Battery Sizing (now based on adjustedBatteryBackupLoadKW)
            const batterySizeNeededKWh = (adjustedBatteryBackupLoadKW * backupHours) / (DoD * inverterEfficiency);
            const numBatteries = Math.ceil(batterySizeNeededKWh / singleBatteryKWh);

            // 2. Daily kWh Usage (based on adjustedDemandLoadKW)
            const dailyKWhUsage = adjustedDemandLoadKW * dailyUsageHours;

            // 3. Solar Panel Quantity (now based on selectedPanelWattage, indirectly adjusted via dailyKWhUsage)
            const totalPanelKW = dailyKWhUsage / avgSunlightHours;
            const numPanels = Math.ceil(totalPanelKW / (selectedPanelWattage / 1000));

            // 4. Inverter Suggestion (based on adjustedDemandLoadKW, rounded up)
            const inverterSuggestionKW = Math.ceil(adjustedDemandLoadKW);

            // Display results
            document.getElementById('connectedLoadOutput').textContent = connectedLoadKW.toFixed(2);
            document.getElementById('demandLoadOutput').textContent = adjustedDemandLoadKW.toFixed(2); // Display adjusted demand load
            document.getElementById('dailyUsageOutput').textContent = dailyKWhUsage.toFixed(2);
            document.getElementById('batteryStorageOutput').textContent = batterySizeNeededKWh.toFixed(2);
            document.getElementById('numBatteriesOutput').textContent = numBatteries;
            document.getElementById('totalPanelKWOutput').textContent = totalPanelKW.toFixed(2);
            document.getElementById('numPanelsOutput').textContent = numPanels;
            document.getElementById('inverterSuggestionOutput').textContent = inverterSuggestionKW;

            // Display selected configuration values in the result panel (lowercase)
            document.getElementById('outputVoltage').textContent = document.getElementById('selectedVoltage').value.toLowerCase() + 'v';
            document.getElementById('outputPhase').textContent = document.getElementById('selectedPhase').value.toLowerCase() + ' phase';
            document.getElementById('outputPowerFactor').textContent = document.getElementById('selectedPowerFactor').value.toLowerCase();
            document.getElementById('outputSystemType').textContent = document.getElementById('systemType').value.toLowerCase().replace('-', ' ');
            document.getElementById('outputBatteryCapacity').textContent = selectedBatteryCapacityAh + 'ah';
            document.getElementById('outputPanelWattage').textContent = selectedPanelWattage + 'w';


            // Show result panel and hide load entry panel
            document.getElementById('loadEntryPanel').classList.add('hidden');
            document.getElementById('resultPanel').classList.remove('hidden');
        }

        // Function to reset the calculator to the load entry panel
        function resetCalculator() {
            document.getElementById('loadEntryPanel').classList.remove('hidden');
            document.getElementById('resultPanel').classList.add('hidden');
        }

        // Function to draw the footer on a given page
        function drawFooter(doc, pageNumber, totalPages) {
            const horizontalMargin = 12.7; // 0.5 inch in mm
            const verticalMargin = 7.62; // 0.3 inch in mm
            const pageHeight = doc.internal.pageSize.height;
            const pageWidth = doc.internal.pageSize.width;

            doc.setFont('Times New Roman', 'normal');
            doc.setFontSize(8);

            // Left bottom: Please Contact: mrashid021ksa@gmail.com (light gray)
            doc.setTextColor(150); // Light gray color
            doc.text('Please Contact: mrashid021ksa@gmail.com', horizontalMargin, pageHeight - verticalMargin + 2.4);

            // Center bottom: Page X of Y (Light gray)
            doc.setTextColor(150); // Light gray color
            const pageNumberText = `Page ${pageNumber} of ${totalPages}`; // Capitalized "Page"
            const textWidth = doc.getStringUnitWidth(pageNumberText) * doc.internal.getFontSize() / doc.internal.scaleFactor;
            const centerX = (pageWidth - textWidth) / 2;
            doc.text(pageNumberText, centerX, pageHeight - verticalMargin + 2.4);

            // Right bottom: Current date and time (Light gray)
            doc.setTextColor(150); // Light gray color
            const now = new Date();
            const dateTimeText = now.toLocaleString(); // Keep original casing for date/time
            const dateTimeTextWidth = doc.getStringUnitWidth(dateTimeText) * doc.internal.getFontSize() / doc.internal.scaleFactor;
            const rightX = pageWidth - horizontalMargin - dateTimeTextWidth;
            doc.text(dateTimeText, rightX, pageHeight - verticalMargin + 2.4);
        }

        // Function to download the result panel as PDF
        async function downloadPdf() {
            const loadingMessage = document.getElementById('loadingMessage');
            loadingMessage.style.display = 'block'; // Show loading message

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const horizontalMargin = 12.7; // 0.5 inch in mm
            const verticalMargin = 7.62; // 0.3 inch in mm
            const imgWidth = doc.internal.pageSize.width - (2 * horizontalMargin);
            const pageHeight = doc.internal.pageSize.height;

            const resultPanel = document.getElementById('resultPanel');
            const pdfButtonsContainer = document.getElementById('pdfButtonsContainer');

            // Apply temporary styles for PDF generation
            const mainHeading = document.getElementById('mainResultHeading');
            const subHeadings = document.querySelectorAll('.result-subheading');
            const resultTexts = document.querySelectorAll('.result-text'); // Select all result text paragraphs

            // Store original classes to revert later
            const originalMainHeadingClasses = mainHeading.className;
            const originalSubHeadingClasses = Array.from(subHeadings).map(h => h.className);
            const originalResultTextClasses = Array.from(resultTexts).map(p => p.className);
            const originalPdfButtonsContainerDisplay = pdfButtonsContainer.style.display;


            // Apply PDF specific styles
            mainHeading.classList.add('pdf-heading-main');
            subHeadings.forEach(h => h.classList.add('pdf-heading-sub'));
            resultTexts.forEach(p => p.classList.add('pdf-body-font'));
            pdfButtonsContainer.style.display = 'none'; // Hide buttons for PDF


            // Add formulas to the HTML temporarily for PDF generation
            const formulaElements = [
                { id: 'connectedLoadOutput', formulaSpanId: 'connectedLoadFormula' },
                { id: 'demandLoadOutput', formulaSpanId: 'demandLoadFormula' },
                { id: 'dailyUsageOutput', formulaSpanId: 'dailyUsageFormula' },
                { id: 'batteryStorageOutput', formulaSpanId: 'batteryStorageFormula' },
                { id: 'numBatteriesOutput', formulaSpanId: 'numBatteriesFormula' },
                { id: 'totalPanelKWOutput', formulaSpanId: 'totalPanelKWFormula' },
                { id: 'numPanelsOutput', formulaSpanId: 'numPanelsFormula' }
            ];

            formulaElements.forEach(item => {
                const outputElement = document.getElementById(item.id);
                const tooltiptextElement = outputElement.nextElementSibling ? outputElement.nextElementSibling.querySelector('.tooltiptext') : null;
                let formulaText = '';

                if (tooltiptextElement) {
                    // Convert formula text to lowercase
                    formulaText = (tooltiptextElement.getAttribute('data-formula') || tooltiptextElement.textContent.split('<br>')[0]).toLowerCase();
                }

                if (outputElement && formulaText) {
                    const formulaSpan = document.createElement('span');
                    formulaSpan.textContent = ` (${formulaText})`;
                    formulaSpan.classList.add('pdf-formula');
                    formulaSpan.id = item.formulaSpanId;

                    outputElement.parentNode.insertBefore(formulaSpan, outputElement.nextSibling);
                }
            });

            // Use html2canvas to render the HTML to a canvas, then add to PDF
            html2canvas(resultPanel, {
                scale: 2, // Increase scale for better resolution in PDF
                useCORS: true // Required if you have images from other domains
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const aspectRatio = canvas.width / canvas.height;
                const imgHeight = imgWidth / aspectRatio; // Calculate height based on new width and aspect ratio

                let currentY = verticalMargin; // Starting Y position for content

                // Add the main content image
                doc.addImage(imgData, 'PNG', horizontalMargin, currentY, imgWidth, imgHeight);
                currentY += imgHeight; // Update current Y position after adding image

                // Add Appliance List to PDF
                // Ensure there's enough space, add a new page if needed
                const tableStartY = currentY + 15; // Start below previous content
                if (tableStartY + 40 > (pageHeight - verticalMargin)) { // Check if table will fit, 40 is an estimate for table header + a few rows
                     doc.addPage();
                     currentY = verticalMargin; // Reset Y for new page
                } else {
                    currentY = tableStartY;
                }

                doc.setFont('Times New Roman', 'normal');
                doc.setFontSize(11);
                doc.text('Appliance Details', horizontalMargin, currentY); // Adjust Y position

                const tableColumn = ["Appliances Name", "Quantity", "Wattage (W)", "Demand Factor (%)", "Battery Backup?"]; // Updated column name
                let tableRows = appliancesDataForPdf.map(item => [
                    item.appliance,
                    item.quantity,
                    item.wattage,
                    `${item.demandFactor}%`, // Add % sign
                    item.isBatteryBackup
                ]);

                // Calculate total connected load for the table footer
                let totalConnectedLoadWattsForTable = 0;
                appliancesDataForPdf.forEach(item => {
                    totalConnectedLoadWattsForTable += item.quantity * item.wattage;
                });

                // Add the "Total Load" row to the tableRows array
                tableRows.push([
                    { content: 'Total Load', colSpan: 2, styles: { fontStyle: 'bold', halign: 'right' } },
                    { content: `${totalConnectedLoadWattsForTable.toFixed(2)} Watts`, colSpan: 3, styles: { fontStyle: 'bold', halign: 'left' } }
                ]);


                doc.autoTable({
                    startY: currentY + 5, // Start below "Appliance Details" heading
                    head: [tableColumn],
                    body: tableRows,
                    theme: 'grid',
                    styles: {
                        font: 'Times New Roman', // Use Times New Roman for table content
                        fontSize: 9,
                        cellPadding: 2,
                        valign: 'middle',
                    },
                    headStyles: {
                        fillColor: [219, 234, 254], // Tailwind blue-100
                        textColor: [29, 78, 216], // Tailwind blue-800
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    columnStyles: {
                        1: { halign: 'center' }, // Quantity
                        2: { halign: 'center' }, // Wattage (W)
                        3: { halign: 'center' }, // Demand Factor (%)
                        4: { halign: 'center' }  // Battery Backup?
                    },
                    alternateRowStyles: {
                        fillColor: [249, 250, 251] // Tailwind gray-50
                    },
                    margin: { top: verticalMargin, left: horizontalMargin, right: horizontalMargin, bottom: verticalMargin },
                });

                // Iterate through all pages to draw the footer
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    drawFooter(doc, i, totalPages);
                }


                doc.save('Solar_System_Sizing_Report.pdf');
            }).catch(error => {
                console.error("Error generating PDF:", error);
            }).finally(() => {
                // Revert styles and remove temporary formula spans after PDF generation
                mainHeading.className = originalMainHeadingClasses;
                subHeadings.forEach((h, index) => h.className = originalSubHeadingClasses[index]);
                resultTexts.forEach((p, index) => p.className = originalResultTextClasses[index]);
                pdfButtonsContainer.style.display = originalPdfButtonsContainerDisplay; // Show buttons again

                formulaElements.forEach(item => {
                    const formulaSpan = document.getElementById(item.formulaSpanId);
                    if (formulaSpan) {
                        formulaSpan.remove();
                    }
                });
                loadingMessage.style.display = 'none'; // Hide loading message
            });
        }


        // Initialize the table with no rows on page load
        window.onload = function() {
            // Clear any existing rows from HTML (though none are hardcoded now)
            document.getElementById('loadTableBody').innerHTML = '';

            // Set initial values for the new input fields to empty string or "Select"
            document.getElementById('selectedVoltage').value = "";
            document.getElementById('selectedPhase').value = "";
            document.getElementById('selectedPowerFactor').value = "";
            document.getElementById('systemType').value = "";
            document.getElementById('selectedBatteryCapacity').value = ""; // Initialize new field
            document.getElementById('selectedPanelWattage').value = ""; // Initialize new field
            document.getElementById('backupHours').value = "";
            document.getElementById('dailyUsageHours').value = "";
        };
    </script>
</body>
</html>
